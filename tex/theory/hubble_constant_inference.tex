% Chapter on Inference
\chapter{Inference of the hubble constant}\label{ch:inference-of-hubble}

\section{Dark Sirens}

Let's now start putting pieces together and construct the setup we will use to infer the hubble constant $\hubble$ from EMRI detections with LISA that do not have an electromagnetic counterpart. This means while the EMRI detection yields a measurement of the luminosity distance $\dl$, we do not have an independent redshift measurement for which one usually uses the electromagnetic counterpart of the measurement. Such measurements lacking of the electromagnetic counterpart are therefore referred to as \emph{Dark Sirens}. This is where the idea of using a galaxy catalog as the counterpart comes into play.

\section{EMRI detections}

When talking about EMRI detections, form now on we mean by that the following,
\begin{definition}
  For our purposes an \emph{EMRI detection} $\detection$ is given by
  \begin{equation}
    \label{eq:emri-detection}
    \bm{D} \coloneqq \left \{ \dl, \vartheta, \varphi, M_z, \bm{\Sigma} (\dl, \vartheta, \varphi, M_z)\right \},
  \end{equation}
  where $\dl, \vartheta, \varphi, M_z, \bm{\Sigma}$ are the luminosity distance, azimuthal angle, longitudinal angle and the redshifted black hole mass, covariance matrix, respectively.
\end{definition}


\section{Galaxy Catalog cross-matching}
The concept of cross-matching the EMRI detections to galaxies in galaxy catalog is well introduced in [REFS]. The idea is that given a detection $\detection$ we can look up the \emph{completeness} of the galaxy catalog in the parameter region of $\detection$. Completeness means the fraction of galaxies that are in the catalog compared to the actual expected number or density of galaxies in given parameter region. We can then assert a likelihood to each galaxy in the catalog for it to be the \emph{host galaxy} of the EMRI detection $\detection$. In other words, since we do not exactly know the source of the EMRI event we simply consider any galaxy to be the possible host galaxy and evaluate how likely it is that the EMRI event was \emph{hosted} by this galaxy.


\section{Bayesian Inference}
The inference of the reduced hubble constant $\rhubble$ from the EMRI detections is a Bayesian inference problem. A detailed derivation of the inference is provided in \cite{10.1093/mnras/stab2741}. We want to infer the posterior distribution of the reduced hubble constant $\rhubble$ given the EMRI detections $\detections$, the galaxy catalog $\galcat$, a cosmological model $\cosmologicalmodel$ and background information on the inference of the hubble constant $\backgroundinformation$. The posterior probability distribution is then given by Bayes' theorem
\begin{equation}
  \label{eq:bayes-theorem}
  p(\rhubble |\detections , \galcat , \cosmologicalmodel) = p(\rhubble | \galcat , \cosmologicalmodel, \backgroundinformation) \frac{p(\detections |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) }{p(\detections | \galcat , \cosmologicalmodel , \backgroundinformation)},
\end{equation}
where the terms on the right hand side of \fullref{eq:bayes-theorem} in more detail are as follows:
\begin{description}
  \item[$p(\rhubble | \galcat , \cosmologicalmodel, \backgroundinformation)$] is the \emph{prior} distribution of the reduced hubble constant given the galaxy catalog, cosmological model and background information.
  \item[$p(\detections |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation)$] is the \emph{likelihood} of the EMRI detections given the reduced hubble constant, galaxy catalog, cosmological model and background information.
  \item[$p(\detections | \galcat , \cosmologicalmodel , \backgroundinformation)$] is the \emph{evidence} of the EMRI detections, galaxy catalog, cosmological model and background information.
\end{description}
\begin{remark}
  The evidence $p(\detections | \galcat , \cosmologicalmodel , \backgroundinformation)$ is only relevant if we want to compare different models such as cosmological models. In our case we will restrict ourselves to the flat ($k=0$) $\lamcdm$ model and therefore the evidence is not needed. Still we can use the evidence to normalize the posterior distribution. Thus, we can write the posterior distribution as
  \begin{equation}
    \label{eq:bayes-theorem-no-evidence}
    \mathcal{N} \coloneqq p(\detections | \galcat , \cosmologicalmodel , \backgroundinformation) \in \mathbb{R}_{>0}.
  \end{equation}
\end{remark}

\subsection{Cosmological model}
The cosmological model we will use in the present work is the flat $\lamcdm$ model. The model is characterized by the following parameters:
\begin{itemize}
  \item Reduced hubble constant $\rhubble$
  \item Matter density $\Omega_m$
  \item Dark energy density $\Omega_\Lambda$
\end{itemize}
The model is based on the FLRW metric and the Friedmann equations. The luminosity distance $\dl$ is then given by
\begin{equation}
  \label{eq:luminosity-distance}
  \dl(z, \rhubble) = (1 + z) \frac{c}{\hubble} \int_0^z \frac{dz'}{\sqrt{\Omega_m (1 + z')^3 + \Omega_\Lambda}},
\end{equation}
which we want to recover from the inference.
Beware that this is a function of $\hubble$ which can be written in terms of the reduced hubble constant $\rhubble$ as
\begin{equation}
  \label{eq:hubble-constant}
  \hubble = 100 \, \text{km/s/Mpc} \cdot \rhubble.
\end{equation}
[TODO: REDSHIFTING OF MEASURED MASS] The redshifted mass $\Mz$ for a (black hole) $\Mbh$ mass at redshift $z$ given by
\begin{equation}
  \label{eq:redshifted-mass}
  \Mz = \Mbh \cdot (1 + z).
\end{equation}

\subsection{Background information}
\subsubsection{Cosmological model information}
The reduced hubble constant $\rhubble$ is the parameter we want to infer from the EMRI detections. The matter density $\Omega_m$ and dark energy density $\Omega_\Lambda$ are fixed to the predicted values of the Millenium run [TODO: REF] $\Omega_m = 0.25$ and $\Omega_\Lambda = 1 - \Omega_m = 0.75$. For the reduced hubble constant we restrict ourselves to the uniformly distributed range $\rhubble \in [0.6, 0.86]$ in accordance with previous predictions [TODO: REFS] and assume the true value to be
\begin{equation}
  \label{eq:true-hubble-constant}
  \rhubble_{\text{true}} = 0.73.
\end{equation}

\subsubsection{EMRI detection assumptions}
The following will be assumed to hold for all (EMRI) detections:
\begin{enumerate}
  \item Detections are statistically uncorrelated
  \item A detection is fully described by a point in parameter space
  \item The BH is the central BH of given galaxy
\end{enumerate}
In more detail, (1) the full likelihood of the EMRI detections is given by the product of the likelihoods of the individual detections. (2) The source of the EMRI event is the position of each possible host galaxy, is hosted by one galaxy and does not change over time. (4) The mass of the central BH is the mass of the BH in the EMRI detection.

\subsection{Prior distribution}
We now need to construct the prior distribution for the reduced hubble constant $\rhubble$. From the background information we know that the reduced hubble constant is uniformly distributed in the range $\rhubble \in [0.6, 0.86]$. Let us define
\begin{equation}
  \label{eq:rhubble-min-max}
  \rhubble_{\text{min}} \coloneqq 0.6, \quad \rhubble_{\text{max}} \coloneqq 0.86.
\end{equation}
The first requirement is therefore
\begin{equation}
  \label{eq:prior-requirement-1}
  p(\rhubble | \galcat , \cosmologicalmodel, \backgroundinformation) \propto \Theta(\rhubble - \rhubble_{\text{min}}) \cdot \Theta(\rhubble_{\text{max}} - h),
\end{equation}
where $\Theta$ is the Heaviside step function.
The second information that the prior distribution inherits is the distance-redshift relation \fullref{eq:luminosity-distance}. Hence, the second requirement is
\begin{equation}
  \label{eq:prior-requirement-2}
  p(\rhubble | \galcat , \cosmologicalmodel, \backgroundinformation) \propto \delta(\dl - \dl(z,\rhubble)).
\end{equation}
Combining both requirements we can write the prior distribution as
\begin{equation}
  \label{eq:prior-distribution}
  p(\rhubble | \galcat , \cosmologicalmodel, \backgroundinformation) \coloneqq \Theta(\rhubble - \rhubble_{\text{min}}) \cdot \Theta(\rhubble_{\text{max}} - h) \cdot \delta(\dl - \dl(z,\rhubble)).
\end{equation}

\subsection{Likelihood}
The construction of the likelihood is the most important part of the inference. The likelihood is the probability of the EMRI detections given the reduced hubble constant, galaxy catalog, cosmological model and background information. From the background information $\backgroundinformation$ we know that the EMRI detections are statistically uncorrelated. Therefore,
\begin{equation}
  \label{eq:likelihood}
  p(\detections |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = \prod_{\detection \in \detections} p(\detection |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation),
\end{equation}
where $p(\detection |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation)$ is the likelihood of a single EMRI detection given the reduced hubble constant, galaxy catalog, cosmological model and background information. In general, EMRI events are described by the full 15 parameters [REF TO CHAPTER]. This means we would have to take all parameters and there correlations into account. The parameters that are used for the inference in other works [TODO: REFS] are the luminosity distance $\dl$, the redshift of the gravitational wave $\zgw$ the azimuthal angle $\vartheta$, the longitudinal angle $\varphi$. We will extend the considered parameters by the mass of the central black hole $\Mbh$. But note that the detection parameter is the redshifted black hole mass $\Mz$. We can trivially rewrite the single detection likelihood as
\begin{equation}
  \label{eq:likelihood-extended}
  \begin{split}
    p(\detection |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = &\frac{1}{\beta(\rhubble)}\int \dd \dl \dd \zgw \dd \varphi \dd \vartheta \dd \Mbh \dd \Mz \\
    &\cdot p(\dl, \zgw, \vartheta, \varphi, \Mbh, \Mz |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    &\cdot p( \detection | \dl, \zgw, \vartheta, \varphi, \Mbh, \Mz, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation),
  \end{split}
\end{equation}
integrating each parameter over its full parameter range and introducing a bias correction term in accordance with . This allows us to evaluate the detection likelihood at given fixed parameters. Still the probability distribution $p(\dl, \zgw, \vartheta, \varphi, \Mbh |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation)$ is not obvious at all. To address this, we will use the chain rule $p(A \cap B) = p(A|B) \cdot p(B)$ to seperate the probability distribution. If two parameters are uncorrelated the chain rule reduces to the product of the individual probability distributions. First, assuming the sky position ($\varphi, \vartheta$) is independent of the other parameters we can rewrite
\begin{equation}
  \label{eq:likelihood-seperated}
  \begin{split}
    p(\dl, \zgw, \vartheta, \varphi, \Mbh |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = &p(\dl, \zgw, \Mbh, \Mz | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    &\cdot p(\vartheta, \varphi | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation).
  \end{split}
\end{equation}
Using the chain rule several times we end up with
\begin{equation}
  \label{eq:likelihood-seperated-2}
  \begin{split}
    p(\dl, \zgw, \Mbh, \Mz | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) &= p(\dl, \Mbh, \Mz | \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    & \quad \cdot p(\zgw | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    &= p(\dl | \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    & \quad \cdot p( \Mz |\Mbh, \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    & \quad \cdot p( \Mbh | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    & \quad \cdot p(\zgw | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation),
  \end{split}
\end{equation}
where we assumed the correlations (indicated by $\sim$): $\dl \sim \zgw , \Mz \sim \zgw , \Mz \sim \Mbh $. Here we can start identifiying some probability distributions. First, we have the redshifted mass $\Mz$ which is given by \fullref{eq:redshifted-mass}, which yields
\begin{equation}
  \label{eq:mass-redshifted-delta}
  p( \Mz |\Mbh, \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = p( \Mz |\Mbh, \zgw, \cosmologicalmodel) = \delta(\Mz - \Mbh \cdot (1 + \zgw)),
\end{equation}
where we first explicitly reduced to the true dependencies for clearer appearance. Similarly, the luminosity distance $\dl$ is given by \fullref{eq:luminosity-distance} and we can write
\begin{equation}
  \label{eq:luminosity-distance-delta}
  p(\dl | \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = p(\dl | \zgw, \cosmologicalmodel) = \delta(\dl - \dl(\zgw, \rhubble)).
\end{equation}
The last two probability distributions in \fullref{eq:likelihood-seperated-2} depend on the galaxy catalog $\galcat$. Plugging \fullref{eq:luminosity-distance-delta} and \fullref{eq:mass-redshifted-delta} back into \fullref{eq:likelihood-seperated-2} we can reinsert everything back into \fullref{eq:likelihood-extended} to obtain
\begin{equation}
  \label{eq:likelihood-extended-2}
  \begin{split}
    p(\detection |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = &\int \dd \vartheta \dd \varphi \dd \Mbh \dd \zgw \dd \dl \dd \Mz \\
    &\cdot \delta(\dl - \dl(\zgw, \rhubble)) \\
    &\cdot \delta(\Mz - \Mbh \cdot (1 + \zgw)) \\
    &\cdot p( \detection | \vartheta, \varphi, \Mbh, \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    &\cdot p(\vartheta, \varphi | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    &\cdot p( \Mbh | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \\
    &\cdot p(\zgw | \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation).
  \end{split}
\end{equation}
The last three probability distributions in \fullref{eq:likelihood-extended-2} depend on the galaxy catalog and recombined can be compactly written as
\begin{equation}
  \label{eq:likelihood-galaxy}
  \begin{split}
    p(\varphi, \vartheta, \Mbh, \zgw | \galcat) &= \sum_{k=1}^{N_g} \delta(\varphi - \varphi_k) \delta(\vartheta - \vartheta_k) \frac{\exp \left \{ - \frac{(\Mbh - \Mbh^{(k)})^2}{2 \sigma_{\Mbh^{(k)}}^2} \right \}}{\sqrt{2 \pi \sigma_{\Mbh^{(k)}}^2}} \frac{\exp \left \{ - \frac{(\zgw - z_k)^2}{2 \sigma_{z_k}^2} \right \}}{\sqrt{2 \pi \sigma_{z_k}^2}} \\
    &= \sum_{k=1}^{N_g} \delta(\varphi - \varphi_k) \delta(\vartheta - \vartheta_k) \normaldistat{\Mbh}{\Mbh^{(k)}} \normaldistat{\zgw}{z_k},
  \end{split}
\end{equation}
recalling that $\normaldistat{x}{\omega}$ is the normal distribution with mean $\omega$ and variance $\sigma^2_{\omega}$ evaluated at $x$. The sum runs over all $N_g$ galaxies in the galaxy catalog. While $\varphi_k, \vartheta_k$ are exact values, $\Mbh^{(k)}$ and $z_k$ come with an error $\sigma_{\Mbh^{(k)}}$ and $\sigma_{z_k}$, respectively, and are therefore modeled as normal distributions. Regarding the normal distribution of the redshift it is important to note that to have a redshift $\zgw$ of the gravitational wave signal it must have originated from a galaxy at the same redshift. The normal distribution evaluated at $\zgw$ reflects the probability that the redshift of the galaxy $k$ coincides with the redshift of the gravitational wave signal. Now we are only left with $p( \detection | \vartheta, \varphi, \Mbh, \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation)$, which is the likelihood of the EMRI signal. As we have derived in [TODO: CHAPTER LISA EMRI PARAMETER ESTIMATION] a EMRI detection is the set of best guess parameters $\bm{\hat{\theta}} = (\hat{\dl}, \hat{\varphi}, \hat{\vartheta}, \hat{\Mz})$ and the covariance matrix $\bm{\Sigma}$ for these parameters obtained from the \emph{Fisher information matrix}. The likelihood of a detection given the parameters the parameters $\bm{\theta} = \dl, \varphi, \vartheta, \Mz$ can then be estimated as a multivariate normal distribution
\begin{equation}
  \label{eq:likelihood-emri-signal}
  p( \detection | \vartheta, \varphi, \Mbh, \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = \frac{1}{\sqrt{(2 \pi)^4 \abs{\bm{\Sigma}}}} \cdot \exp \left \{-\frac{1}{2}\bm{\tilde{\theta}}^T \bm{\Sigma}^{-1} \bm{\tilde{\theta}} \right \},
\end{equation}
where $\bm{\tilde{\theta}} = \bm{\theta} - \bm{\hat{\theta}}$ is the difference between the parameters and the best guess parameters. Finally, we can plug \fullref{eq:likelihood-galaxy} and \fullref{eq:likelihood-emri-signal} back into \fullref{eq:likelihood-extended-2} to obtain the full likelihood of the EMRI detection:
\begin{equation}
  \label{eq:likelihood-full}
  \begin{split}
    p(\detection |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = &\int \dd \vartheta \dd \varphi \dd \Mbh \dd \zgw \dd \dl \dd \Mz \\
    &\cdot \delta(\dl - \dl(\zgw, \rhubble)) \\
    &\cdot \delta(\Mz - \Mbh \cdot (1 + \zgw)) \\
    &\cdot \frac{1}{\sqrt{(2 \pi)^4 \abs{\bm{\Sigma}}}} \cdot \exp \left \{-\frac{1}{2}\bm{\tilde{\theta}}^T \bm{\Sigma}^{-1} \bm{\tilde{\theta}} \right \} \\
    &\cdot \sum_{k=1}^{N_g} \delta(\varphi - \varphi_k) \delta(\vartheta - \vartheta_k) \normaldistat{\Mbh}{\Mbh^{(k)}} \normaldistat{\zgw}{z_k}.
  \end{split}
\end{equation}
Performing the integration over the sky position $\varphi, \vartheta$, luminosity distance $\dl$ and the redshifted blaack hole mass $\Mz$ we can use the delta functions to simplify the expression. The final likelihood of the EMRI detection is then given by:

\begin{equation}
  \label{eq:likelihood-final}
  \boxed{
    p(\detection |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = \iint \dd \zgw \dd \Mbh \sum_{k=1}^{N_g} \left[ \frac{\exp \left \{-\frac{1}{2}\bm{\tilde{\theta}}^T \bm{\Sigma}^{-1} \bm{\tilde{\theta}} \right \}}{\sqrt{(2 \pi)^4 \abs{\bm{\Sigma}}}} \normaldistat{\Mbh}{\Mbh^{(k)}} \normaldistat{\zgw}{z_k} \right]
  }
\end{equation}

This is the final single event likelihood that we will use for the Bayesian inference of $\rhubble$ when we consider the black hole mass. For the reference results without considering the black hole mass we will use 
\begin{equation}
  \label{eq:likelihood-final-without-mass}
  \boxed{
    p(\detection |\rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) = \iint \dd \zgw \sum_{k=1}^{N_g} \left[ \frac{\exp \left \{-\frac{1}{2}\bm{\tilde{\theta}}_{3d}^T \bm{\Sigma}_{3d}^{-1} \bm{\tilde{\theta}}_{3d} \right \}}{\sqrt{(2 \pi)^4 \abs{\bm{\Sigma}_{3d}}}} \normaldistat{\zgw}{z_k} \right]
  }
\end{equation}

\section{Normalization}\label{sec:normalization}
In general, if we neglect the normalization $\beta(\rhubble)$ in \fullref{eq:likelihood-extended} and it was just an overall constant independent of $\rhubble$, the inference would not be biased even if the likelihood is not normalized. However, the normalization does indeed depend on $\rhubble$ and is derived in \cite{Gair_2023, Fishbach_2019, Chen_2018}. The effects that come into play are on the one hand, the so called \emph{GW selection effects} that take into account that not all EMRI events are detected and mostly depend on the luminosity distance $\dl$. On the other hand, the galaxy distribution in the galaxy catalog $\galcat$ has an effect on the normalization because the single event likelihoods most important gaussian peak is 
\begin{equation}
  p(\detection | \vartheta, \varphi, \Mbh, \zgw, \rhubble , \galcat , \cosmologicalmodel, \backgroundinformation) \propto \exp \left \{-\frac{(\dl - \dl(\zgw, \rhubble))}{2\sigma_{\dl}}\right \}.
\end{equation}
Most important in the sense that it uses the $\dl - z$ relation to evaluate whether given redshift is compatible with the luminosity distance. This means, as we increase the value of $\rhubble$ the optimal redshift $\zgw$ for the detection will change. As a consequence galaxies at higher redshifts will be more likely to be the host of the EMRI event. If at the same time the galaxy distribution increases with $z$ the likelihood will just increase with $\rhubble$. [TODO: FINAL NORMALIZATION THAT IS BEING USED]